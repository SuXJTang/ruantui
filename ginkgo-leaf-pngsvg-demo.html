<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>银杏叶PNG-SVG动态背景演示</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      /* CSS变量用于统一管理颜色和主题 */
      --bg-gradient-from: #f0f4f8;
      --bg-gradient-to: #d9e6f2;
      --bg-angle: 135deg;
      --card-bg: rgba(255, 255, 255, 0.85);
      --card-shadow: rgba(0, 0, 0, 0.15);
      --card-border: rgba(255, 255, 255, 0.2);
      --text-primary: #2a3f54;
      --text-secondary: #34495e;
      --accent-color: rgba(255, 255, 255, 0.5);
      
      /* 动画参数 */
      --transition-speed: 0.5s;
      --card-scale: 1.02;
    }
    
    /* 减少选择器嵌套，提高CSS解析速度 */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      /* 使用CSS变量，支持动态更改 */
      background: linear-gradient(var(--bg-angle), var(--bg-gradient-from) 0%, var(--bg-gradient-to) 100%);
      min-height: 100vh;
      margin: 0;
      overflow: hidden;
      position: relative;
      perspective: 1000px;
      font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
      transition: background var(--transition-speed) ease;
      
      /* 启用硬件加速 */
      will-change: background;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    #container {
      position: relative;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }

    #leafContainer {
      position: absolute;
      width: 100%;
      height: 100%;
      /* 启用3D加速 */
      transform: translateZ(0);
    }

    /* 使用属性选择器减少选择器层级 */
    [id^="leaf-"] {
      position: absolute;
      pointer-events: none;
      will-change: transform;
      backface-visibility: hidden;
      -webkit-animation-iteration-count: infinite, infinite;
      -webkit-animation-direction: normal, normal;
      -webkit-animation-timing-function: linear, ease-in;
      /* 启用硬件加速 */
      transform: translateZ(0);
    }
    
    /* 使用属性选择器优化CSS选择器性能 */
    /* 近景层叶子 - 更大更清晰 */
    [id^="leaf-"].foreground {
      width: 110px;
      height: 75px;
      opacity: 1;
      z-index: 3;
      filter: blur(0px);
    }
    
    /* 中景层叶子 - 标准大小 */
    [id^="leaf-"].midground {
      width: 80px;
      height: 55px;
      opacity: 0.9;
      z-index: 2;
      filter: blur(1px);
    }
    
    /* 远景层叶子 - 更小更模糊 */
    [id^="leaf-"].background {
      width: 60px;
      height: 40px;
      opacity: 0.75;
      z-index: 1;
      filter: blur(2px);
    }

    [id^="leaf-"] > svg {
      position: absolute;
      width: 100%;
      height: 100%;
      -webkit-animation-iteration-count: infinite;
      -webkit-animation-direction: alternate;
      -webkit-animation-timing-function: ease-in-out;
      -webkit-transform-origin: 50% -100%;
      will-change: transform;
    }

    /* 叶子拖尾效果 */
    .leaf-trail {
      position: absolute;
      pointer-events: none;
      opacity: 0.4;
      transform-origin: center center;
      transition: opacity 0.3s;
      filter: blur(1px);
      animation: trail-fade 0.8s ease-out;
      will-change: transform, opacity;
      
      /* 启用3D加速 */
      transform: translateZ(0);
    }

    /* 拖尾淡出动画 */
    @keyframes trail-fade {
      0% { opacity: 0.6; filter: blur(0px); transform: scale(1.05) translateZ(0); }
      100% { opacity: 0.3; filter: blur(2px); transform: scale(0.95) translateZ(0); }
    }
    
    /* 元素淡出动画 */
    @keyframes fadeOut {
      0% { opacity: 0.4; }
      100% { opacity: 0; }
    }

    /* 叶子淡出动画 */
    @-webkit-keyframes fade {
      0%   { opacity: 1; }
      95%  { opacity: 1; }
      100% { opacity: 0; }
    }

    /* 叶子下落动画 - 使用transform而非top/left属性 */
    @-webkit-keyframes drop {
      0%   { -webkit-transform: translate3d(0, -50px, 0); }
      100% { -webkit-transform: translate3d(0, 110vh, 0); }
    }

    /* 顺时针旋转 - 使用transform:rotate3d加速 */
    @-webkit-keyframes clockwiseSpin {
      0%   { -webkit-transform: rotate3d(0, 0, 1, -50deg); }
      100% { -webkit-transform: rotate3d(0, 0, 1, 50deg); }
    }

    /* 逆时针旋转并翻转 - 使用transform:rotate3d加速 */
    @-webkit-keyframes counterclockwiseSpinAndFlip {
      0%   { -webkit-transform: scale3d(-1, 1, 1) rotate3d(0, 0, 1, 50deg); }
      100% { -webkit-transform: scale3d(-1, 1, 1) rotate3d(0, 0, 1, -50deg); }
    }
    
    /* 改进卡片样式 */
    .card {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 10px 40px var(--card-shadow), 
                  0 0 0 1px var(--card-border) inset;
      padding: 40px 46px;
      max-width: 520px;
      text-align: center;
      z-index: 10;
      transition: all var(--transition-speed) ease;
      
      /* 提高性能 */
      will-change: transform, opacity;
      transform: translate3d(-50%, -50%, 0);
    }
    
    /* 卡片悬停效果 */
    .card:hover {
      transform: translate3d(-50%, -50%, 0) scale(var(--card-scale));
      box-shadow: 0 15px 50px var(--card-shadow),
                  0 0 0 1px rgba(255, 255, 255, 0.25) inset;
    }
    
    .card h1 {
      font-size: 2.6rem;
      color: var(--text-primary);
      margin-bottom: 1.2rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-shadow: 0 2px 3px rgba(0,0,0,0.05);
      transition: all var(--transition-speed) ease;
    }
    
    .card-content {
      color: var(--text-secondary);
      font-size: 1.15rem;
      line-height: 2;
      position: relative;
      padding: 0.8em 0;
    }
    
    .card-content p {
      margin: 0 0 1.2em;
      position: relative;
      padding-left: 1.2em;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    
    .card-content p:hover {
      transform: translateX(5px);
      color: #000;
    }
    
    .card-content p:before {
      content: "";
      position: absolute;
      left: 0;
      top: 0.85em;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: var(--text-primary);
      transition: transform 0.3s ease, background-color 0.3s ease;
    }
    
    .card-content p:hover:before {
      transform: scale(1.5);
      background-color: currentColor;
    }
    
    /* 鼠标指针影响效果 */
    .cursor-effect {
      position: absolute;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      pointer-events: none;
      background: radial-gradient(circle, var(--accent-color) 0%, rgba(255,255,255,0) 70%);
      transform: translate(-50%, -50%);
      z-index: 9;
      opacity: 0;
      transition: opacity 0.3s ease;
      
      /* 启用硬件加速 */
      will-change: transform, opacity;
      transform: translate3d(-50%, -50%, 0);
    }
    
    /* 添加鼠标波纹效果 */
    .cursor-ripple {
      position: absolute;
      pointer-events: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0) 70%);
      transform: translate3d(-50%, -50%, 0);
      z-index: 10;
      animation: ripple 1s ease-out forwards;
      will-change: transform, opacity;
    }
    
    @keyframes ripple {
      0% { width: 20px; height: 20px; opacity: 1; }
      100% { width: 300px; height: 300px; opacity: 0; }
    }
    
    /* 轻微震动效果 */
    @keyframes slight-shake {
      0% { transform: translate(0, 0) rotate(0); }
      25% { transform: translate(2px, 2px) rotate(0.5deg); }
      50% { transform: translate(-1px, -2px) rotate(-0.5deg); }
      75% { transform: translate(-3px, 1px) rotate(0.25deg); }
      100% { transform: translate(0, 0) rotate(0); }
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
      .card {
        width: 85%;
        padding: 30px 20px;
      }
      
      .card h1 {
        font-size: 2rem;
      }
      
      .card-content {
        font-size: 1rem;
      }
      
      /* 减少移动端叶子数量，提高性能 */
      [id^="leaf-"].background {
        display: none;
      }
    }
    
    /* 页面载入动画 */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 1s ease forwards;
    }
    
    .card {
      opacity: 0;
      animation: fadeIn 1s ease 0.5s forwards;
    }
    
    /* 性能检测器样式 */
    #performance-monitor {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 1000;
      display: none; /* 默认隐藏 */
    }
  </style>
</head>
<body>
<div id="container">
  <div id="leafContainer"></div>
</div>

<div id="cursorEffect" class="cursor-effect"></div>

<div class="card">
  <h1>三秋叶</h1>
  <div class="card-content">
    <p>春色银杏叶：嫩绿充满生机，随风轻摇，象征成长与希望。</p>
    <p>秋霜银杏叶：金黄转深红，缓缓飘落，唤起成熟与思念。</p>
    <p>冬雪银杏叶：纯白通透，如雪花轻飘，代表宁静与新生。</p>
  </div>
</div>

<!-- 性能监视器 - 使用?debug=true参数显示 -->
<div id="performance-monitor">
  FPS: <span id="fps-counter">0</span> | 
  叶子: <span id="leaf-counter">0</span> | 
  拖尾: <span id="trail-counter">0</span>
</div>

<script>
// 在脚本开始处添加性能监控变量和调试模式
// 性能参数
let performanceMode = 'auto'; // 'high', 'medium', 'low', 'auto'
let debugMode = false;

// 三个SVG字符串（纯矢量SVG）
const svgList = [
  // 黄
  `<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 288 192"><path d="M0 0 C0.71655762 0.00080566 1.43311523 0.00161133 2.17138672 0.00244141 C9.04271315 0.08135103 15.33382345 0.95774137 21.75 3.5 C24.46475105 4.52554547 24.46475105 4.52554547 26.75 2.875 C28.0803125 2.0396875 28.0803125 2.0396875 29.4375 1.1875 C34.84071519 -0.07687211 38.32231134 0.05490651 43.4375 2.1875 C46.77422627 2.92271087 50.11989879 3.57340183 53.4765625 4.2109375 C56.82035372 5.31377101 57.71620259 6.18523708 59.4375 9.1875 C61.14243358 12.68710051 61.95272452 15.309466 61.4375 19.1875 C59.83839309 21.4362441 58.24408095 23.43402921 56.4375 25.5 C42.3444405 42.55391995 34.92664135 64.09322291 36.4375 86.1875 C37.51125483 92.54548137 39.62431951 95.83400528 44.4375 100.1875 C60.73073895 111.43302963 80.84159387 116.36768589 100.5 116.5 C101.51694946 116.50833862 101.51694946 116.50833862 102.55444336 116.5168457 C107.48146099 116.44579171 111.71573541 115.4516338 116.4375 114.1875 C119.4375 114.0625 119.4375 114.0625 121.4375 114.1875 C121.6875 116.5 121.6875 116.5 121.4375 119.1875 C118.7865681 122.28025389 115.75707426 122.71503743 111.8046875 123.0625 C89.17287251 124.25757934 69.04384065 119.74812323 48.61401367 110.20019531 C46.2789459 109.11372744 43.93773343 108.04285958 41.58984375 106.984375 C40.86788818 106.65791992 40.14593262 106.33146484 39.40209961 105.99511719 C29.68555809 102.00079392 18.01558254 104.22447761 8.56054688 107.92138672 C-2.81770785 112.80894324 -12.64493115 119.87211729 -22.5625 127.1875 C-37.71778222 138.22365424 -37.71778222 138.22365424 -46.21875 137.91796875 C-51.47492806 136.27979325 -54.66317428 131.63960268 -57.5625 127.1875 C-58.57435099 124.61664898 -59.26546587 122.14238839 -59.8828125 119.453125 C-60.95385744 115.88297519 -63.01991257 113.86390783 -65.5625 111.1875 C-66.74046194 108.83157612 -66.76874468 107.12374337 -66.9375 104.5 C-67.23978614 100.91867771 -67.65150802 99.00289076 -69.25 95.6875 C-71.08129439 90.80404829 -70.03047438 87.08373161 -68.5625 82.1875 C-68.0675 81.1975 -68.0675 81.1975 -67.5625 80.1875 C-67.53657276 76.91696345 -67.58948722 73.66116017 -67.68945312 70.39257812 C-67.80114127 63.3562247 -66.41741452 56.77988178 -62.08203125 51.10546875 C-57.71689685 47.78255248 -52.45352185 46.61479233 -47.19165039 45.26538086 C-46.37043701 45.04889893 -45.54922363 44.83241699 -44.703125 44.609375 C-43.95579102 44.42987305 -43.20845703 44.25037109 -42.43847656 44.06542969 C-40.42511509 43.32015497 -40.42511509 43.32015497 -39.34814453 41.37402344 C-38.54342016 39.134399 -38.13421704 37.14194827 -37.8515625 34.78125 C-37.74070313 33.95496094 -37.62984375 33.12867188 -37.515625 32.27734375 C-37.29699626 30.5517383 -37.08604618 28.82514251 -36.8828125 27.09765625 C-36.01391826 20.76855161 -36.01391826 20.76855161 -33.64453125 17.71875 C-31.00864993 15.78016561 -28.30196124 13.97653591 -25.5625 12.1875 C-24.7375 11.5275 -23.9125 10.8675 -23.0625 10.1875 C-20.33319456 8.00405565 -17.47919728 6.11127906 -14.5625 4.1875 C-13.840625 3.630625 -13.11875 3.07375 -12.375 2.5 C-8.545708 -0.27293559 -4.52349412 -0.00521741 0 0 Z" fill="#EEAF11" transform="translate(157.5625,11.8125)"/></svg>`,
  // 白
  `<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 288 192"><path d="M0 0 C0.71655762 0.00080566 1.43311523 0.00161133 2.17138672 0.00244141 C9.04271315 0.08135103 15.33382345 0.95774137 21.75 3.5 C24.46475105 4.52554547 24.46475105 4.52554547 26.75 2.875 C28.0803125 2.0396875 28.0803125 2.0396875 29.4375 1.1875 C34.84071519 -0.07687211 38.32231134 0.05490651 43.4375 2.1875 C46.77422627 2.92271087 50.11989879 3.57340183 53.4765625 4.2109375 C56.82035372 5.31377101 57.71620259 6.18523708 59.4375 9.1875 C61.14243358 12.68710051 61.95272452 15.309466 61.4375 19.1875 C59.83839309 21.4362441 58.24408095 23.43402921 56.4375 25.5 C42.3444405 42.55391995 34.92664135 64.09322291 36.4375 86.1875 C37.51125483 92.54548137 39.62431951 95.83400528 44.4375 100.1875 C60.73073895 111.43302963 80.84159387 116.36768589 100.5 116.5 C101.51694946 116.50833862 101.51694946 116.50833862 102.55444336 116.5168457 C107.48146099 116.44579171 111.71573541 115.4516338 116.4375 114.1875 C119.4375 114.0625 119.4375 114.0625 121.4375 114.1875 C121.6875 116.5 121.6875 116.5 121.4375 119.1875 C118.7865681 122.28025389 115.75707426 122.71503743 111.8046875 123.0625 C89.17287251 124.25757934 69.04384065 119.74812323 48.61401367 110.20019531 C46.2789459 109.11372744 43.93773343 108.04285958 41.58984375 106.984375 C40.86788818 106.65791992 40.14593262 106.33146484 39.40209961 105.99511719 C29.68555809 102.00079392 18.01558254 104.22447761 8.56054688 107.92138672 C-2.81770785 112.80894324 -12.64493115 119.87211729 -22.5625 127.1875 C-37.71778222 138.22365424 -37.71778222 138.22365424 -46.21875 137.91796875 C-51.47492806 136.27979325 -54.66317428 131.63960268 -57.5625 127.1875 C-58.57435099 124.61664898 -59.26546587 122.14238839 -59.8828125 119.453125 C-60.95385744 115.88297519 -63.01991257 113.86390783 -65.5625 111.1875 C-66.74046194 108.83157612 -66.76874468 107.12374337 -66.9375 104.5 C-67.23978614 100.91867771 -67.65150802 99.00289076 -69.25 95.6875 C-71.08129439 90.80404829 -70.03047438 87.08373161 -68.5625 82.1875 C-68.0675 81.1975 -68.0675 81.1975 -67.5625 80.1875 C-67.53657276 76.91696345 -67.58948722 73.66116017 -67.68945312 70.39257812 C-67.80114127 63.3562247 -66.41741452 56.77988178 -62.08203125 51.10546875 C-57.71689685 47.78255248 -52.45352185 46.61479233 -47.19165039 45.26538086 C-46.37043701 45.04889893 -45.54922363 44.83241699 -44.703125 44.609375 C-43.95579102 44.42987305 -43.20845703 44.25037109 -42.43847656 44.06542969 C-40.42511509 43.32015497 -40.42511509 43.32015497 -39.34814453 41.37402344 C-38.54342016 39.134399 -38.13421704 37.14194827 -37.8515625 34.78125 C-37.74070313 33.95496094 -37.62984375 33.12867188 -37.515625 32.27734375 C-37.29699626 30.5517383 -37.08604618 28.82514251 -36.8828125 27.09765625 C-36.01391826 20.76855161 -36.01391826 20.76855161 -33.64453125 17.71875 C-31.00864993 15.78016561 -28.30196124 13.97653591 -25.5625 12.1875 C-24.7375 11.5275 -23.9125 10.8675 -23.0625 10.1875 C-20.33319456 8.00405565 -17.47919728 6.11127906 -14.5625 4.1875 C-13.840625 3.630625 -13.11875 3.07375 -12.375 2.5 C-8.545708 -0.27293559 -4.52349412 -0.00521741 0 0 Z" fill="#FFFFFF" transform="translate(157.5625,11.8125)"/></svg>`,
  // 绿
  `<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 288 192"><path d="M0 0 C0.71655762 0.00080566 1.43311523 0.00161133 2.17138672 0.00244141 C9.04271315 0.08135103 15.33382345 0.95774137 21.75 3.5 C24.46475105 4.52554547 24.46475105 4.52554547 26.75 2.875 C28.0803125 2.0396875 28.0803125 2.0396875 29.4375 1.1875 C34.84071519 -0.07687211 38.32231134 0.05490651 43.4375 2.1875 C46.77422627 2.92271087 50.11989879 3.57340183 53.4765625 4.2109375 C56.82035372 5.31377101 57.71620259 6.18523708 59.4375 9.1875 C61.14243358 12.68710051 61.95272452 15.309466 61.4375 19.1875 C59.83839309 21.4362441 58.24408095 23.43402921 56.4375 25.5 C42.3444405 42.55391995 34.92664135 64.09322291 36.4375 86.1875 C37.51125483 92.54548137 39.62431951 95.83400528 44.4375 100.1875 C60.73073895 111.43302963 80.84159387 116.36768589 100.5 116.5 C101.51694946 116.50833862 101.51694946 116.50833862 102.55444336 116.5168457 C107.48146099 116.44579171 111.71573541 115.4516338 116.4375 114.1875 C119.4375 114.0625 119.4375 114.0625 121.4375 114.1875 C121.6875 116.5 121.6875 116.5 121.4375 119.1875 C118.7865681 122.28025389 115.75707426 122.71503743 111.8046875 123.0625 C89.17287251 124.25757934 69.04384065 119.74812323 48.61401367 110.20019531 C46.2789459 109.11372744 43.93773343 108.04285958 41.58984375 106.984375 C40.86788818 106.65791992 40.14593262 106.33146484 39.40209961 105.99511719 C29.68555809 102.00079392 18.01558254 104.22447761 8.56054688 107.92138672 C-2.81770785 112.80894324 -12.64493115 119.87211729 -22.5625 127.1875 C-37.71778222 138.22365424 -37.71778222 138.22365424 -46.21875 137.91796875 C-51.47492806 136.27979325 -54.66317428 131.63960268 -57.5625 127.1875 C-58.57435099 124.61664898 -59.26546587 122.14238839 -59.8828125 119.453125 C-60.95385744 115.88297519 -63.01991257 113.86390783 -65.5625 111.1875 C-66.74046194 108.83157612 -66.76874468 107.12374337 -66.9375 104.5 C-67.23978614 100.91867771 -67.65150802 99.00289076 -69.25 95.6875 C-71.08129439 90.80404829 -70.03047438 87.08373161 -68.5625 82.1875 C-68.0675 81.1975 -68.0675 81.1975 -67.5625 80.1875 C-67.53657276 76.91696345 -67.58948722 73.66116017 -67.68945312 70.39257812 C-67.80114127 63.3562247 -66.41741452 56.77988178 -62.08203125 51.10546875 C-57.71689685 47.78255248 -52.45352185 46.61479233 -47.19165039 45.26538086 C-46.37043701 45.04889893 -45.54922363 44.83241699 -44.703125 44.609375 C-43.95579102 44.42987305 -43.20845703 44.25037109 -42.43847656 44.06542969 C-40.42511509 43.32015497 -40.42511509 43.32015497 -39.34814453 41.37402344 C-38.54342016 39.134399 -38.13421704 37.14194827 -37.8515625 34.78125 C-37.74070313 33.95496094 -37.62984375 33.12867188 -37.515625 32.27734375 C-37.29699626 30.5517383 -37.08604618 28.82514251 -36.8828125 27.09765625 C-36.01391826 20.76855161 -36.01391826 20.76855161 -33.64453125 17.71875 C-31.00864993 15.78016561 -28.30196124 13.97653591 -25.5625 12.1875 C-24.7375 11.5275 -23.9125 10.8675 -23.0625 10.1875 C-20.33319456 8.00405565 -17.47919728 6.11127906 -14.5625 4.1875 C-13.840625 3.630625 -13.11875 3.07375 -12.375 2.5 C-8.545708 -0.27293559 -4.52349412 -0.00521741 0 0 Z" fill="#04F15B" transform="translate(157.5625,11.8125)"/></svg>`
];

// 颜色映射
const colorMap = {
  "#EEAF11": "rgba(238, 175, 17, ", // 黄色
  "#FFFFFF": "rgba(255, 255, 255, ", // 白色
  "#04F15B": "rgba(4, 241, 91, "    // 绿色
};

// 定义全局变量和常量
const NUMBER_OF_LEAVES = 30;
const TRAIL_LENGTH = 12;
const MOUSE_TRAIL_LENGTH = 18;
const MOUSE_INFLUENCE_RADIUS = 150;

// 缓存DOM引用
let leafContainer;
let cursorEffect;

// 叶子位置记录 - 使用Map而不是对象，性能更好
const leafPositions = new Map();

// 增加缓存SVG字符串的变量，避免重复解析
let cachedSvgContents = [];

// 性能跟踪变量
let lastFrameTime = 0;
let framesPerSecond = 0;
let frameCount = 0;
const fpsUpdateInterval = 1000; // 每秒更新一次FPS

// 初始化函数 - 应用程序入口点
function initApp() {
  // 检查URL参数
  const urlParams = new URLSearchParams(window.location.search);
  debugMode = urlParams.get('debug') === 'true';
  
  // 如果有性能参数
  if (urlParams.has('performance')) {
    performanceMode = urlParams.get('performance');
  }
  
  // 根据性能模式调整参数
  adjustPerformanceSettings();
  
  // 显示调试信息
  if (debugMode) {
    document.getElementById('performance-monitor').style.display = 'block';
    
    // 添加性能计数器更新
    setInterval(updatePerformanceMonitor, 1000);
  }
  
  // 启动页面动画
  document.body.classList.add('fade-in');
  
  // 延迟初始化叶子动画
  setTimeout(() => {
    init(); // 初始化叶子
    document.querySelector('.card').style.opacity = '1'; // 显示卡片
  }, 300);
  
  // 如果浏览器支持，启用可视性API管理性能
  if ('visibilityState' in document) {
    document.addEventListener('visibilitychange', handleVisibilityChange);
  }
  
  // 支持热重载的开发环境
  if (debugMode) {
    console.log('调试模式已启用');
    console.log('性能模式:', performanceMode);
    console.log('使用参数: ?performance=high/medium/low/auto&debug=true');
  }
}

// 根据性能模式调整设置
function adjustPerformanceSettings() {
  // 自动模式下检测设备性能
  if (performanceMode === 'auto') {
    // 检测移动设备
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    // 检测低端设备 - 简单启发式方法
    const isLowEndDevice = navigator.hardwareConcurrency <= 2 || isMobile;
    
    performanceMode = isLowEndDevice ? 'low' : 
                     (navigator.hardwareConcurrency <= 4 ? 'medium' : 'high');
  }
  
  // 根据性能模式设置参数
  switch (performanceMode) {
    case 'low':
      NUMBER_OF_LEAVES = 15;
      TRAIL_LENGTH = 5;
      MOUSE_TRAIL_LENGTH = 8;
      break;
    case 'medium':
      NUMBER_OF_LEAVES = 25;
      TRAIL_LENGTH = 8;
      MOUSE_TRAIL_LENGTH = 12;
      break;
    case 'high':
      NUMBER_OF_LEAVES = 35;
      TRAIL_LENGTH = 12;
      MOUSE_TRAIL_LENGTH = 18;
      break;
  }
}

// 处理页面可见性变化
function handleVisibilityChange() {
  if (document.hidden) {
    // 页面不可见时暂停不必要的动画
    document.body.classList.add('paused');
  } else {
    // 页面可见时恢复动画
    document.body.classList.remove('paused');
    
    // 如果动画已经停止太久，重新初始化
    if (Date.now() - lastFrameTime > 5000) {
      resetLeafContainer();
      
      const fragment = document.createDocumentFragment();
      for (let i = 0; i < NUMBER_OF_LEAVES; i++) {
        fragment.appendChild(createALeaf(i));
      }
      leafContainer.appendChild(fragment);
    }
  }
}

// 更新性能监视器
function updatePerformanceMonitor() {
  if (!debugMode) return;
  
  document.getElementById('fps-counter').textContent = framesPerSecond;
  document.getElementById('leaf-counter').textContent = document.querySelectorAll('#leafContainer > div').length;
  document.getElementById('trail-counter').textContent = document.querySelectorAll('.leaf-trail').length;
  
  // 自动调整性能
  if (framesPerSecond < 30 && NUMBER_OF_LEAVES > 15) {
    NUMBER_OF_LEAVES = Math.max(15, NUMBER_OF_LEAVES - 5);
    TRAIL_LENGTH = Math.max(5, TRAIL_LENGTH - 2);
    MOUSE_TRAIL_LENGTH = Math.max(8, MOUSE_TRAIL_LENGTH - 3);
    
    console.log('性能低，自动降级:', {
      叶子数量: NUMBER_OF_LEAVES,
      拖尾长度: TRAIL_LENGTH,
      鼠标影响拖尾: MOUSE_TRAIL_LENGTH
    });
  }
}

// 初始化函数
function init() {
  // 获取DOM元素引用
  leafContainer = document.getElementById('leafContainer');
  cursorEffect = document.getElementById('cursorEffect');
  
  // 预缓存SVG内容，避免重复解析
  svgList.forEach(svg => {
    const div = document.createElement('div');
    div.innerHTML = svg;
    cachedSvgContents.push(div.firstChild);
  });
  
  // 使用createDocumentFragment减少DOM操作
  const fragment = document.createDocumentFragment();
  
  // 填充容器，创建叶子
  for (let i = 0; i < NUMBER_OF_LEAVES; i++) {
    fragment.appendChild(createALeaf(i));
  }
  
  // 一次性添加所有叶子
  leafContainer.appendChild(fragment);
  
  // 启动主循环
  requestAnimationFrame(mainLoop);
  
  // 添加事件监听器
  setupEventListeners();
}

// 设置事件监听器，集中管理
function setupEventListeners() {
  // 窗口大小改变处理
  const resizeHandler = debounce(() => {
    resetLeafContainer();
    
    // 使用createDocumentFragment减少DOM操作
    const fragment = document.createDocumentFragment();
    
    // 重新创建叶子
    for (let i = 0; i < NUMBER_OF_LEAVES; i++) {
      fragment.appendChild(createALeaf(i));
    }
    
    // 一次性添加所有叶子
    leafContainer.appendChild(fragment);
    
    // 清除所有拖尾
    clearAllTrails();
  }, 200);  // 添加防抖，避免调整大小时频繁重建
  
  window.addEventListener('resize', resizeHandler);
  
  // 页面可见性变化处理
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      // 页面重新可见时重置
      resetLeafContainer();
      
      // 使用createDocumentFragment减少DOM操作
      const fragment = document.createDocumentFragment();
      
      // 重新创建叶子
      for (let i = 0; i < NUMBER_OF_LEAVES; i++) {
        fragment.appendChild(createALeaf(i));
      }
      
      // 一次性添加所有叶子
      leafContainer.appendChild(fragment);
    }
  });
  
  // 鼠标移动和点击处理
  const container = document.getElementById('container');
  
  // 使用节流处理鼠标移动事件，减少计算负担
  container.addEventListener('mousemove', throttle((e) => {
    // 更新光效位置
    cursorEffect.style.left = e.clientX + 'px';
    cursorEffect.style.top = e.clientY + 'px';
    cursorEffect.style.opacity = '1';
    
    // 影响附近的叶子
    influenceNearbyLeaves(e.clientX, e.clientY);
  }, 16)); // 约60fps
  
  // 鼠标离开时隐藏效果
  container.addEventListener('mouseleave', () => {
    cursorEffect.style.opacity = '0';
  });
  
  // 添加鼠标点击效果
  container.addEventListener('click', (e) => {
    // 创建点击波纹效果
    createRippleEffect(e.clientX, e.clientY);
    
    // 强烈影响点击区域的叶子
    influenceNearbyLeaves(e.clientX, e.clientY, true);
  });
}

// 创建波纹效果，单独函数便于复用
function createRippleEffect(x, y) {
  const ripple = document.createElement('div');
  ripple.className = 'cursor-ripple';
  ripple.style.left = x + 'px';
  ripple.style.top = y + 'px';
  document.body.appendChild(ripple);
  
  // 动画结束后移除波纹，避免DOM节点堆积
  ripple.addEventListener('animationend', () => ripple.remove());
}

// 主循环，统一管理动画帧
function mainLoop(timestamp) {
  // 计算帧率
  updateFrameRate(timestamp);
  
  // 更新所有叶子的位置和拖尾
  updateLeaves(timestamp);
  
  // 下一帧继续
  requestAnimationFrame(mainLoop);
}

// 更新帧率
function updateFrameRate(timestamp) {
  frameCount++;
  
  // 每秒更新一次FPS
  if (timestamp - lastFrameTime >= fpsUpdateInterval) {
    framesPerSecond = Math.round((frameCount * 1000) / (timestamp - lastFrameTime));
    frameCount = 0;
    lastFrameTime = timestamp;
    
    // 低帧率时自动降低拖尾数量以提高性能
    if (framesPerSecond < 30 && TRAIL_LENGTH > 5) {
      TRAIL_LENGTH = 5;
      MOUSE_TRAIL_LENGTH = 8;
    }
  }
}

// 更新所有叶子
function updateLeaves(timestamp) {
  // 限制更新频率
  if (timestamp - (updateLeaves.lastUpdate || 0) < 16) return;
  updateLeaves.lastUpdate = timestamp;
  
  // 批量收集需要更新的拖尾数据
  const allTrailData = [];
  
  // 更新所有叶子的拖尾
  leafPositions.forEach((positions, id) => {
    const leaf = document.getElementById('leaf-' + id);
    
    if (leaf && positions.length > 0) {
      const rect = leaf.getBoundingClientRect();
      const x = rect.left + rect.width / 2;
      const y = rect.top + rect.height / 2;
      
      // 计算移动距离
      let shouldAddPosition = true;
      if (positions.length > 0) {
        const lastPos = positions[positions.length - 1];
        const distance = Math.hypot(x - lastPos.x, y - lastPos.y); // 使用Math.hypot更高效
        // 只有移动足够距离才添加新位置，避免静止时产生太多点
        shouldAddPosition = distance > 3;
      }
      
      if (shouldAddPosition) {
        // 添加新位置
        positions.push({ 
          x, 
          y, 
          rotation: leaf.style.transform,
          timestamp
        });
        
        // 限制拖尾长度
        if (positions.length > (leaf.classList.contains('mouse-influenced') ? MOUSE_TRAIL_LENGTH : TRAIL_LENGTH)) {
          positions.shift();
        }
        
        // 收集拖尾数据
        const trailData = prepareTrailData(id, positions, leaf);
        if (trailData.length) {
          allTrailData.push(...trailData);
        }
      }
    }
  });
  
  // 批量创建所有拖尾
  if (allTrailData.length) {
    createTrailBatch(allTrailData);
  }
}

// 准备拖尾数据
function prepareTrailData(id, positions, leaf) {
  // 移除旧的拖尾
  const oldTrails = document.querySelectorAll(`.leaf-trail[data-leaf-id="${id}"]`);
  oldTrails.forEach(trail => trail.remove());
  
  // 如果位置太少，不显示拖尾
  if (positions.length < 2) return [];
  
  // 准备拖尾数据
  const trailData = [];
  for (let i = 0; i < positions.length - 1; i++) {
    trailData.push({
      position: positions[i],
      leaf,
      id,
      index: i,
      total: positions.length
    });
  }
  
  return trailData;
}

// 防抖函数：限制函数调用频率
function debounce(func, wait) {
  let timeout;
  return function() {
    const context = this, args = arguments;
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(context, args), wait);
  };
}

// 节流函数：确保函数在一定时间内最多执行一次
function throttle(func, limit) {
  let inThrottle;
  return function() {
    const context = this, args = arguments;
    if (!inThrottle) {
      func.apply(context, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
}

// 从缓存获取SVG内容
function getSvgFromCache(index) {
  if (cachedSvgContents[index]) {
    return cachedSvgContents[index].cloneNode(true);
  }
  return null;
}

// 创建一片叶子的函数改进
function createALeaf(id) {
  // 创建一个包装div
  const leafDiv = document.createElement('div');
  leafDiv.id = 'leaf-' + id;
  
  // 初始化位置数组
  leafPositions.set(id, []);
  
  // 分配深度层 - 近景，中景或远景
  const depthLayer = Math.floor(Math.random() * 3);
  leafDiv.className = ['foreground', 'midground', 'background'][depthLayer];
  
  // 随机选择一种SVG叶子
  const svgIndex = Math.floor(Math.random() * svgList.length);
  
  // 设置叶子的初始位置 - 使用transforms而不是left/top以提高性能
  const startX = Math.random() * window.innerWidth - 100;
  leafDiv.style.transform = `translateX(${startX}px) translateY(-100px)`;
  
  // 根据深度层调整下落速度
  const durationMultiplier = [1.0, 1.5, 2.0][depthLayer];
  
  // 随机设置动画参数
  const fadeAndDropDuration = (8 + Math.random() * 8) * durationMultiplier;
  const leafDelay = Math.random() * 7;
  
  // 设置动画
  Object.assign(leafDiv.style, {
    webkitAnimationName: 'fade, drop',
    webkitAnimationDuration: `${fadeAndDropDuration}s, ${fadeAndDropDuration}s`,
    webkitAnimationDelay: `${leafDelay}s, ${leafDelay}s`
  });
  
  // 创建SVG元素 - 从缓存获取以提高性能
  const svgElem = getSvgFromCache(svgIndex) || document.createElementNS("http://www.w3.org/2000/svg", "svg");
  
  // 如果没有从缓存获取到，则设置SVG内容
  if (!svgElem.innerHTML) {
    const svgContent = svgList[svgIndex];
    const div = document.createElement('div');
    div.innerHTML = svgContent;
    const newSvg = div.firstChild;
    
    // 复制属性
    Array.from(newSvg.attributes).forEach(attr => {
      svgElem.setAttribute(attr.name, attr.value);
    });
    
    // 复制内容
    svgElem.innerHTML = newSvg.innerHTML;
  }
  
  // 随机选择旋转动画
  const spinAnimationName = Math.random() < 0.5 ? 'clockwiseSpin' : 'counterclockwiseSpinAndFlip';
  
  // 设置SVG元素的动画
  Object.assign(svgElem.style, {
    webkitAnimationName: spinAnimationName,
    webkitAnimationDuration: `${4 + Math.random() * 4}s`
  });
  
  // 将SVG添加到div中
  leafDiv.appendChild(svgElem);
  
  // 为叶子添加动画结束监听
  leafDiv.addEventListener('animationend', function(e) {
    if (e.animationName === 'fade') {
      // 当淡出动画结束时，创建新的叶子替换此叶子
      const newLeaf = createALeaf(id);
      if (this.parentNode) {
        this.parentNode.replaceChild(newLeaf, this);
      }
    }
  });
  
  // 返回创建的叶子div
  return leafDiv;
}

// 页面加载完成后初始化应用
window.addEventListener('DOMContentLoaded', initApp);

// 将animationend事件监听移到全局事件委托
document.addEventListener('animationend', function(e) {
  if (e.animationName === 'fade' && e.target.id && e.target.id.startsWith('leaf-')) {
    const id = e.target.id.split('-')[1];
    // 当淡出动画结束时，创建新的叶子替换此叶子
    const newLeaf = createALeaf(id);
    if (e.target.parentNode) {
      e.target.parentNode.replaceChild(newLeaf, e.target);
    }
  } else if (e.animationName === 'ripple' && e.target.classList.contains('cursor-ripple')) {
    // 波纹动画结束后删除元素
    e.target.remove();
  }
});

// 使用IntersectionObserver懒加载提高性能
if ('IntersectionObserver' in window) {
  // 为可视区域外的叶子暂停动画
  const leafObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.target.classList.contains('leaf-trail')) {
        if (!entry.isIntersecting) {
          entry.target.style.animationPlayState = 'paused';
        } else {
          entry.target.style.animationPlayState = 'running';
        }
      }
    });
  }, { rootMargin: '100px' });
  
  // 监视所有叶子和拖尾
  function observeLeaves() {
    document.querySelectorAll('#leafContainer > div, .leaf-trail').forEach(leaf => {
      leafObserver.observe(leaf);
    });
  }
  
  // 初始化后观察
  setTimeout(observeLeaves, 1000);
}

// 添加垃圾回收功能，防止内存泄漏
function garbageCollect() {
  // 清理不再存在的叶子的位置记录
  leafPositions.forEach((positions, id) => {
    if (!document.getElementById('leaf-' + id)) {
      leafPositions.delete(id);
    }
  });
  
  // 清理孤立的拖尾元素
  document.querySelectorAll('.leaf-trail').forEach(trail => {
    const leafId = trail.dataset.leafId;
    if (!document.getElementById('leaf-' + leafId)) {
      trail.remove();
    }
  });
}

// 定期执行垃圾回收
setInterval(garbageCollect, 10000);

// 批量创建拖尾元素，提高性能
function createTrailBatch(trailData) {
  // 使用文档片段减少DOM操作
  const fragment = document.createDocumentFragment();
  
  // 使用对象池减少对象创建和GC负担
  const trailElements = getTrailElementsFromPool(trailData.length);
  
  trailData.forEach((data, index) => {
    const { position, leaf, id, index: trailIndex, total } = data;
    const trailElement = trailElements[index];
    
    // 重置/初始化元素
    trailElement.className = 'leaf-trail';
    trailElement.dataset.leafId = id;
    
    // 获取叶子的SVG内容 - 使用缓存提高性能
    const leafSvg = leaf.querySelector('svg');
    const svgContent = leafSvg ? leaf._cachedSvgContent || leafSvg.outerHTML : '';
    
    // 缓存SVG内容以避免重复查询
    if (!leaf._cachedSvgContent && svgContent) {
      leaf._cachedSvgContent = svgContent;
    }
    
    // 计算参数
    const opacity = (trailIndex + 1) / total * 0.5;
    const scale = 0.7 + (trailIndex / total * 0.3);
    
    // 添加随机性 - 预计算以提高性能
    const isMouseInfluenced = leaf.classList.contains('mouse-influenced');
    const randomOffset = isMouseInfluenced ? 3 : 1;
    const offsetX = (Math.random() - 0.5) * randomOffset;
    const offsetY = (Math.random() - 0.5) * randomOffset;
    const randomRotation = (Math.random() - 0.5) * 10;
    
    // 批量设置样式 - 使用transforms提高性能
    const transformValue = `translate(-50%, -50%) translate(${offsetX}px, ${offsetY}px) ${position.rotation || ''} rotate(${randomRotation}deg)`;
    
    // 使用cssText一次性设置多个样式属性，减少重绘
    trailElement.style.cssText = `
      position: absolute; 
      left: ${position.x}px; 
      top: ${position.y}px; 
      width: ${leaf.offsetWidth * scale}px; 
      height: ${leaf.offsetHeight * scale}px; 
      transform: ${transformValue}; 
      opacity: ${opacity}; 
      z-index: 1;
      ${isMouseInfluenced ? 
        `filter: blur(${(1 - trailIndex / total) * 2}px) brightness(1.2); 
         box-shadow: 0 0 5px rgba(255,255,255,0.3);` : 
        `filter: blur(${(1 - trailIndex / total) * 3}px);`
      }
    `;
    
    // 设置内容 - 避免不必要的DOM操作
    if (trailElement.innerHTML !== svgContent) {
      trailElement.innerHTML = svgContent;
    }
    
    // 给SVG路径设置新的颜色和透明度
    const path = trailElement.querySelector('path');
    if (path) {
      const leafColor = getLeafColor(leaf);
      if (leafColor) {
        // 受鼠标影响的叶子拖尾颜色更亮
        if (isMouseInfluenced) {
          const color = leafColor.replace('rgba(', '').split(',')[0];
          if (color === '238' || color === '255') { // 黄色或白色
            path.setAttribute('fill', `rgba(255, 255, ${trailIndex % 2 ? '180' : '220'}, ${opacity})`);
          } else { // 绿色
            path.setAttribute('fill', `rgba(120, 255, ${trailIndex % 2 ? '180' : '220'}, ${opacity})`);
          }
        } else {
          path.setAttribute('fill', `${leafColor}${opacity})`);
        }
      }
    }
    
    fragment.appendChild(trailElement);
  });
  
  // 一次性添加所有拖尾元素
  document.body.appendChild(fragment);
}

// 使用对象池减少垃圾回收
const trailElementPool = [];

function getTrailElementsFromPool(count) {
  const elements = [];
  
  for (let i = 0; i < count; i++) {
    if (trailElementPool.length > 0) {
      // 从池中取出元素
      elements.push(trailElementPool.pop());
    } else {
      // 创建新元素
      elements.push(document.createElement('div'));
    }
  }
  
  return elements;
}

// 修改清除拖尾函数，回收元素到对象池
function clearAllTrails() {
  const trails = document.querySelectorAll('.leaf-trail');
  
  trails.forEach(trail => {
    // 添加淡出动画
    trail.style.animation = 'fadeOut 0.3s forwards';
    
    // 延迟回收DOM元素到对象池
    setTimeout(() => {
      if (trail.parentNode) {
        trail.parentNode.removeChild(trail);
      }
      
      // 重置并放回对象池
      trail.innerHTML = '';
      trail.className = '';
      trail.style.cssText = '';
      
      // 最多保留100个元素在池中
      if (trailElementPool.length < 100) {
        trailElementPool.push(trail);
      }
    }, 300);
  });
}

// 改进影响鼠标附近的叶子函数，减少计算和提高效率
function influenceNearbyLeaves(mouseX, mouseY, strongEffect = false) {
  // 使用空间分区优化 - 只检查可能受影响的叶子
  const influenceRadius = strongEffect ? MOUSE_INFLUENCE_RADIUS * 1.5 : MOUSE_INFLUENCE_RADIUS;
  const leaves = getNearbyLeaves(mouseX, mouseY, influenceRadius);
  
  // 计算影响的叶子数量
  let affectedCount = 0;
  
  // 批量处理样式变更，减少重绘
  const styleUpdates = [];
  
  leaves.forEach(leaf => {
    const rect = leaf.getBoundingClientRect();
    const leafX = rect.left + rect.width / 2;
    const leafY = rect.top + rect.height / 2;
    
    // 计算距离 - 使用Math.hypot更高效
    const distance = Math.hypot(mouseX - leafX, mouseY - leafY);
    
    // 如果叶子在影响范围内
    if (distance < influenceRadius) {
      affectedCount++;
      
      // 添加受影响标记
      leaf.classList.add('mouse-influenced');
      
      // 为受影响的叶子更新拖尾长度
      const id = leaf.id.split('-')[1];
      if (leafPositions.has(id)) {
        const positions = leafPositions.get(id);
        // 强烈影响时拖尾更长
        const maxTrailLength = strongEffect ? MOUSE_TRAIL_LENGTH * 1.5 : MOUSE_TRAIL_LENGTH;
        while (positions.length > maxTrailLength) {
          positions.shift();
        }
      }
      
      // 计算影响力度
      const influence = 1 - (distance / influenceRadius);
      
      // 计算偏移方向和强度
      const multiplier = strongEffect ? 1.5 : 0.8;
      const directionX = (leafX - mouseX) * influence * multiplier;
      const directionY = (leafY - mouseY) * influence * multiplier;
      
      // 收集样式更新
      styleUpdates.push({
        leaf,
        styles: {
          transition: 'transform 0.3s ease',
          transform: `translate(${directionX}px, ${directionY}px)`,
          filter: `brightness(${strongEffect ? 1.4 : 1.2}) drop-shadow(0 0 ${strongEffect ? '8px' : '3px'} rgba(255,255,255,0.5))`
        },
        timeout: strongEffect ? 800 : 500
      });
    }
  });
  
  // 批量应用样式更新
  requestAnimationFrame(() => {
    styleUpdates.forEach(update => {
      const { leaf, styles, timeout } = update;
      
      // 应用样式
      Object.assign(leaf.style, styles);
      
      // 设置重置计时器
      setTimeout(() => {
        leaf.style.transform = '';
        leaf.style.filter = '';
        leaf.classList.remove('mouse-influenced');
      }, timeout);
    });
  });
  
  // 如果是强烈影响，添加额外的视觉效果
  if (strongEffect && affectedCount > 0) {
    // 改变背景渐变方向 - 使用CSS变量避免重绘
    document.documentElement.style.setProperty('--bg-angle', `${Math.random() * 360}deg`);
    
    // 震动效果
    document.body.style.animation = 'none';
    requestAnimationFrame(() => {
      document.body.style.animation = 'slight-shake 0.5s ease-out';
    });
  }
}

// 使用空间分区优化 - 只检查可能受影响的叶子
function getNearbyLeaves(x, y, radius) {
  // 简单实现 - 在生产环境中可以使用四叉树等空间索引结构
  const allLeaves = document.querySelectorAll('#leafContainer > div');
  const candidateLeaves = [];
  
  // 使用视口范围筛选
  const left = x - radius;
  const right = x + radius;
  const top = y - radius;
  const bottom = y + radius;
  
  allLeaves.forEach(leaf => {
    const rect = leaf.getBoundingClientRect();
    
    // 快速边界框检测
    if (rect.right >= left && rect.left <= right && 
        rect.bottom >= top && rect.top <= bottom) {
      candidateLeaves.push(leaf);
    }
  });
  
  return candidateLeaves;
}
</script>
</body>
</html> 